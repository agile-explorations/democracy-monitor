# Security rules
#
# These rules catch common security mistakes that ESLint can't express.
# Run with: pnpm lint:patterns

rules:
  # WHY: API keys committed to source control are exposed to anyone with
  # repo access (and in git history forever, even if deleted later). Keys
  # must come from environment variables. This rule matches string literals
  # that look like OpenAI (sk-...) or Anthropic (sk-ant-...) API keys.
  - id: no-hardcoded-api-keys
    pattern-regex: '[''"](?:sk-|key-)[a-zA-Z0-9_-]{20,}[''"]'
    message: >-
      Possible hardcoded API key. Use environment variables instead
      (e.g., process.env.OPENAI_API_KEY). Keys in source control are
      exposed in git history even if deleted later.
    languages: [typescript]
    severity: ERROR
    paths:
      exclude:
        - '*.test.*'
        - '*.md'

  # WHY: External URLs in lib/services/ should go through the proxy layer
  # (pages/api/proxy.ts) which enforces the host allowlist, caches responses,
  # and handles CORS. Direct fetch to external URLs bypasses these protections
  # and will fail from the browser due to CORS.
  - id: no-raw-external-fetch
    pattern-regex: "fetch\\(['\"]https?://"
    message: >-
      Use the proxy layer (/api/proxy) or feed-service instead of
      fetching external URLs directly. The proxy enforces the host
      allowlist, handles CORS, and caches responses.
    languages: [typescript]
    severity: WARNING
    paths:
      include:
        - lib/services
      exclude:
        - lib/services/feed-fetcher.ts
        - lib/services/intent-data-service.ts

  # WHY: Components should read AI results from snapshots, not call AI API
  # routes directly. Direct calls (/api/ai/*) bypass the snapshot system,
  # cause expensive AI calls on every page load, and produce inconsistent
  # results across refreshes. AI calls belong in the snapshot cron.
  - id: no-component-ai-fetch
    pattern-regex: "fetch\\(['\"`]/api/ai/"
    message: >-
      Components should not call /api/ai/* directly. AI results are stored
      in snapshots by the cron job and read via /api/snapshots/latest.
      Direct AI calls bypass caching and run on every page load.
    languages: [typescript]
    severity: ERROR
    paths:
      include:
        - components

  # WHY: Cron scripts run via tsx outside of Next.js, so .env.local is not
  # loaded automatically. Without loadEnvConfig(), DATABASE_URL and API keys
  # will be undefined, causing silent failures or crashes. Every cron script
  # that accesses env vars (DB, Redis, AI) must call loadEnvConfig().
  - id: cron-needs-env-config
    patterns:
      - pattern: getDb()
      - pattern-not-inside: |
          loadEnvConfig(...)
          ...
    message: >-
      Cron scripts run outside Next.js and must call loadEnvConfig() to
      load .env.local. Add: import { loadEnvConfig } from '@next/env';
      loadEnvConfig(process.cwd()); at the top of the file.
    languages: [typescript]
    severity: ERROR
    paths:
      include:
        - lib/cron
      exclude:
        - '*.test.*'
